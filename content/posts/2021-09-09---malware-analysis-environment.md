---
title: Malware Analysis - Part II - Preparing an environment
date: "2021-09-09T19:00:00.169Z"
template: "post"
draft: false
slug: "malware-analysis-environment"
category: "Malware"
tags:
  - "Malware"
description: "Before getting our hands dirty with malware samples, we should create a secure environment."
socialImage: "/media/flarevm.png"
---

# Requirements
Malware analysis environment should:
* be isolated
* be easily recoverable
* contain all necessary tools for the malware analysis process

## Isolation
Secure malware environment means isolation. Ideally, your environment should be based on hardware dedicated just for this purpose. It's crucial to avoid using a computer containing critical/sensitive files and one used for sensitive actions like logging into the bank, etc. Even if all of the malware-related activities will be done in a virtual machine, we can encounter super-intelligent malware with sandbox escape capabilities. Just be prepared for the worst.

In terms of networking, VMs in the time of analysis and detonation shouldn't have access to the internet. If you can do some advanced networking, it's a good idea to put a host in the separated VLAN (or even physically separated network) to add another layer of isolation. Also, it may be a good idea to tunnel whole traffic through a VPN connection, as, in the worst scenario, your actual IP address and location will not be exposed.

## Recoverable
Utilizing virtualization should fulfill this requirement. Just do not forget to do snapshots regularly. Some malware may have protection to behave differently in virtualized environment vs. non-virtualized environment (in ex. stop executing when VM-like drivers or system properties are detected). We will handle such scenarios case by case. For now, let's focus on building as generic environment as possible.

If for some reason, you don't like to use VMs for analysis, reboot-to-restore solutions may help you to save and restore the environment. Examples: [Shadow Defender](http://www.shadowdefender.com/). [DeepFreeze](https://www.faronics.com/en-uk/products/deep-freeze). Disk Cloning software: [Clonezilla](http://clonezilla.org), [FOG](https://www.fogproject.org).

## Tooling
The number of tools available for malware analysis could be overwhelming. Tools should be able to handle:
* disassemble malware sample,
* perform sample static properties analysis,
* debug and analyze what happens in OS,
* analyze network traffic,
* perform code analysis,
* malware debugging and patching.

You can find great tools showcased in the form of mindmap at [malwareanalysis.tools](https://malwareanalysis.tools/index.html).


# Setup
To minimalize time needed for a setup malware analysis tools, let's choose popular solutions:
* For Linux: [REMnux](https://docs.remnux.org/)
* For Windows: [FireEye FLARE VM](https://github.com/fireeye/flare-vm)

## VMs instalation
1. Choose hardware that you'd like to use for analysis.
2. Install virtualization solutions like VMWare / Virtual Box on your host.
3. Import REMnux as the first VM by following this [instruction](https://docs.remnux.org/install-distro/get-virtual-appliance).
4. Download and install Windows 10 as a second VM. If you have a license key use it, otherwise Windows 10 developer environment could be downloaded from [here](https://developer.microsoft.com/en-us/microsoft-edge/tools/vms/).
5. For the time of installation, turn on bridge networking (access to the internet is necessary to install flare) and follow [flare installation guide](https://github.com/fireeye/flare-vm#windows-10-installation) on Windows VM.
6. Note that in Flare Pre-installation Steps, there are instructions to turn off the Microsoft Defender. It's essential to keep it turned off to not interfere with malicious samples.

## Network configuration
Created VMs should be joined to the same private network and connected together.
1. In VirtualBox or VMware create new private network (VMWare -> Preferences -> Network):
* do *not* allow virtual machines on this network to connect to external networks
* add custom subnet IP and mask in ex. 192.168.174.0 / 255.255.255.0
![VMware new network](/media/malware-env-setup/vmware-network.png)
2. Attach created network to both REMnux and Flare VMs. Network interfaces should refresh automatically.
3. In REMnux: run `if config` to get IP address and note IP.
4. In FlareVM:
* type `ipconfig /release` to release attached IP address,
* go to network adapter settings (Control Panel\All Control Panel Items\Network Connections ->{NETWORK_ADAPTER_NAME}->Properties->Internet Protocol Version 4 (TCP/IPv4) -> Properties),
* in IP address field add IP address in the range of previously defined network, this setup makes IP static,
* in Subnet mask add network subnet (255.255.255.0),
* in Default gateway and Preferred DNS server add REMNux IP address - in result all generated network traffic will go through REMnux.
![FlareVM network settings](/media/malware-env-setup/flare-network-configuration.png)
5. In REMnux:
* remove firewall rules to allow Flare VM connections. It can be done using build in command: `accept-all-ips start eth0`
* run fakedns server, to be able to see DNS requests made by Flare - command `fakedns`.
* run internet simulation as in some cases malware is checking if victim has access to internet, this solution will try to trick such samples, command: `inetsim`
6. To test this setup:
* in FlareVM go to google.com, you should see following page:
![Inetsim check](/media/malware-env-setup/inetsim-check.png)
* in REMnux in fakedns tab you should see log entry like:
`fakedns[INFO]: Response: google.com -> 192.168.174.6`

I hope this setup makes sense to you. In the next episode - malware analysis methodology. [Follow me on Twitter](https://twitter.com/_f44z) to not miss it. 

See you soon, Ahoy!



