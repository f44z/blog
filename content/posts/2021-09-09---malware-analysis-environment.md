---
title: Malware Analysis - Part II - Preparing an environment
date: "2021-09-09T19:00:00.169Z"
template: "post"
draft: false
slug: "malware-analysis-environment"
category: "Malware"
tags:
  - "Malware"
description: "Before getting our hands dirty with malware samples, we should create a secure environment."
socialImage: "/media/flarevm.png"
---

# Requirements
Malware analysis environment should:
* be isolated
* be easily recoverable
* contain all necessary tools for the malware analysis process

## Isolation
Secure malware environment means isolation. Ideally, your environment should be based on hardware dedicated just for this purpose. It's crucial to avoid using a computer containing critical/sensitive files and one used for sensitive actions like logging into the bank, etc. Even if all of the malware-related activities will be done in a virtual machine, we can encounter super-intelligent malware with sandbox escape capabilities. Just be prepared for the worst.

In terms of networking, VMs in the time of analysis and detonation shouldn't have access to the internet. If you can do some advanced networking, it's a good idea to put a host in the separated VLAN (or even physically separated network) to add another layer of isolation. Also, it may be a good idea to tunnel whole traffic through a VPN connection, as, in the worst scenario, your actual IP address and location will not be exposed.

## Recoverable
Utilizing virtualization should fulfill this requirement. Just do not forget to do snapshots regularly. Some malware may have protection to behave differently in virtualized environment vs. non-virtualized environment (in ex. stop executing when VM-like drivers or system properties are detected). We will handle such scenarios case by case. For now, let's focus on building as generic environment as possible.

If for some reason, you don't like to use VMs for analysis, reboot-to-restore solutions may help you to save and restore the environment. Examples: [Shadow Defender](http://www.shadowdefender.com/). [DeepFreeze](https://www.faronics.com/en-uk/products/deep-freeze). Disk Cloning software: [Clonezilla](http://clonezilla.org), [FOG](https://www.fogproject.org).

## Tooling
The number of tools available for malware analysis could be overwhelming. Tools should be able to handle:
* disassemble malware sample,
* perform sample static properties analysis,
* debug and analyze what happens in OS,
* analyze network traffic,
* perform code analysis,
* malware debugging and patching.

You can find great tools showcased in the form of mindmap at [malwareanalysis.tools](https://malwareanalysis.tools/index.html).

To minimalize time needed for a setup these tools, let's choose popular solutions:
* For Linux: [REMnux](https://docs.remnux.org/)
* For Windows: [FireEye FLARE VM](https://github.com/fireeye/flare-vm)

## Instalation
1. Choose hardware that you'd like to use for analysis.
2. Install virtualization solutions like VMWare / Virtual Box on your host.
3. Import REMnux as the first VM by following this [instruction](https://docs.remnux.org/install-distro/get-virtual-appliance).
4. Download and install Windows 10 as a second VM. If you have a license key use it, otherwise Windows 10 developer environment could be downloaded from [here](https://developer.microsoft.com/en-us/windows/downloads/virtual-machines/).
5. For the time of installation, turn on bridge networking (access to the internet is necessary to install flare) and follow [flare installation guide](https://github.com/fireeye/flare-vm#windows-10-installation) on Windows VM.
6. Note that in Flare Pre-installation Steps, there are instructions to turn off the Microsoft Defender. It's essential to keep it turned off to not interfere with sample analysis.
7. Join created VMs to private network / internal network - so VMs should not have access to the internet or host but should be connected - test it.
8. Create separate network in VMWare - private network (set IP address range)
In windows ipconfig /release
In linux: run dhclient eth0 

9. Setup in windows so it will - network local area connection:
make static IP address (same as in network setting in vmware)
default gateway should point to linux machine

10. Enable firewall rules on linux:
accept-all-ips (preconfigured in remnux)

11. On remnux run fakedns server

12. On remnux run inetsim (to simulate network)

In the next episode - malware analysis methodology. [Follow me on Twitter](https://twitter.com/_f44z) to not miss it. 

See you soon, Ahoy!



